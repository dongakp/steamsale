{% extends "base.html" %}
{% load humanize %}
{% load static %}
{% block title %}Steam Dashboard{% endblock %}

{% block content %}
<div class="container-fluid px-4">
  <h1 class="mt-4">Steam Sale Dashboard</h1>
  <ol class="breadcrumb mb-4">
    <li class="breadcrumb-item active">Dashboard</li>
  </ol>

  <div class="row">
    <!-- Line Chart -->
    <div class="col-lg-6 mb-4">
      <div class="card">
        <div class="card-header">
          <i class="fas fa-chart-line me-1"></i> ì›”ë³„ ì¶œì‹œ ê²Œì„ ìˆ˜
        </div>
        <div class="card-body">
          <canvas id="monthlyChart"></canvas>
        </div>
      </div>
    </div>

    <!-- Bar Chart -->
    <div class="col-lg-6 mb-4">
      <div class="card">
        <div class="card-header">
          <i class="fas fa-chart-bar me-1"></i> í• ì¸ìœ¨ êµ¬ê°„ë³„ ê²Œì„ ìˆ˜
        </div>
        <div class="card-body">
          <canvas id="discountChart"></canvas>
        </div>
      </div>
    </div>

    <!-- Scatter Chart -->
    <div class="col-lg-6 mb-4">
      <div class="card">
        <div class="card-header">
          <i class="fas fa-bullseye me-1"></i> ì¶œì‹œì¼ vs í• ì¸ìœ¨
        </div>
        <div class="card-body">
          <canvas id="scatterChart"></canvas>
        </div>
      </div>
    </div>

    <!-- Word Cloud -->
    <div class="col-lg-6 mb-4">
      <div class="card">
        <div class="card-header">
          <i class="fas fa-cloud me-1"></i> ì¸ê¸° íƒœê·¸ Word Cloud
        </div>
        <div class="card-body text-center">
          <img src="{% static 'images/word_cloud.png' %}" alt="ì›Œë“œ í´ë¼ìš°ë“œ" class="img-fluid">
        </div>
      </div>
    </div>
  </div>

  <!-- Table -->
  <div class="card mb-4">
    <div class="card-header">
      ğŸ“‹ í¬ë¡¤ë§ëœ ê²Œì„ ëª©ë¡
    </div>
    <div class="card-body">
      <table id="gameTable" class="table table-bordered table-striped">
        <thead>
          <tr>
            <th>ì œëª©</th>
            <th>í• ì¸ìœ¨</th>
            <th>ì¶œì‹œì¼</th>
            <th>íƒœê·¸</th>
            <th>í‰ì </th>
            <th>ë¦¬ë·° ìˆ˜</th>
            <th>ê°€ê²©</th>
          </tr>
        </thead>
        <tbody>
          {% for game in games %}
          <tr>
            <td>{{ game.title }}</td>
            <td>{{ game.discount_rate }}%</td>
            <td>{{ game.release_date }}</td>
            <td>{{ game.tags }}</td>
            <td>{{ game.review_pct }}%</td>
            <td>{{ game.review_count|intcomma }}</td>
            <td>â‚©{{ game.discounted_price|intcomma }}</td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
  </div>
</div>
{% endblock %}

{% block extra_scripts %}
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.2.1/dist/chart.umd.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/luxon@3.4.3/build/global/luxon.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-luxon@1.3.1/dist/chartjs-adapter-luxon.umd.min.js"></script>
<script src="https://cdn.datatables.net/1.13.4/js/jquery.dataTables.min.js"></script>

<script>
  fetch("/visualization-data/")
    .then(res => res.json())
    .then(data => {
      // Line Chart (ì›”ë³„ ì¶œì‹œ ìˆ˜)
      new Chart(document.getElementById("monthlyChart"), {
        type: "line",
        data: {
          labels: data.monthly_release_spline.x.map(x => `${x}ì›”`),
          datasets: [{
            label: "ê²Œì„ ìˆ˜",
            data: data.monthly_release_spline.y,
            borderColor: "rgba(78, 115, 223, 1)",
            backgroundColor: "rgba(78, 115, 223, 0.1)",
            fill: true,
            tension: 0.4
          }]
        },
        options: {
          responsive: true,
          plugins: {
            title: { display: true, text: "ì›”ë³„ ì¶œì‹œ ê²Œì„ ìˆ˜" },
            legend: { display: false }
          },
          scales: {
            y: {
              beginAtZero: true,
              title: { display: true, text: "ê²Œì„ ìˆ˜" }
            }
          }
        }
      });

      // Bar Chart (í• ì¸ìœ¨ ë¶„í¬)
      new Chart(document.getElementById("discountChart"), {
        type: "bar",
        data: {
          labels: data.discount_distribution.map(d => d.range),
          datasets: [{
            label: "ê²Œì„ ìˆ˜",
            data: data.discount_distribution.map(d => d.count),
            backgroundColor: "rgba(28, 200, 138, 0.6)"
          }]
        },
        options: {
          responsive: true,
          plugins: {
            title: { display: true, text: "í• ì¸ìœ¨ êµ¬ê°„ë³„ ê²Œì„ ìˆ˜" },
            legend: { display: false }
          },
          scales: {
            y: {
              beginAtZero: true,
              title: { display: true, text: "ê²Œì„ ìˆ˜" }
            }
          }
        }
      });

      // Scatter Chart (ì¶œì‹œì¼ vs í• ì¸ìœ¨)
      const scatterData = data.release_discount_scatter.map(d => ({
        x: luxon.DateTime.fromISO(d.release_date).toJSDate(), 
        y: d.discount_rate
      }));

      new Chart(document.getElementById("scatterChart"), {
        type: "scatter",
        data: {
          datasets: [{
            label: "ì¶œì‹œì¼ vs í• ì¸ìœ¨",
            data: scatterData,
            backgroundColor: "rgba(255, 99, 132, 0.6)"
          }]
        },
        options: {
          responsive: true,
          plugins: {
            title: { display: true, text: "ì¶œì‹œì¼ vs í• ì¸ìœ¨" },
            legend: { display: false }
          },
          scales: {
            x: {
              type: "time",
              time: {
                unit: "month",
                displayFormats: {
                  month: "yyyyë…„ Mì›”"
                }
              },
              title: {
                display: true,
                text: "ì¶œì‹œì¼"
              },
              ticks: {
                autoSkip: true,
                maxTicksLimit: 8
              }
            },
            y: {
              beginAtZero: true,
              title: { display: true, text: "í• ì¸ìœ¨ (%)" }
            }
          }

        }
      });
    });

  // í…Œì´ë¸”
  window.addEventListener('DOMContentLoaded', () => {
    $('#gameTable').DataTable();
  });
</script>
{% endblock %}
